---
phase: 03-voice-reliability
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - docker-compose.yml
  - Dockerfile.coturn
  - priv/coturn/turnserver.conf
autonomous: true
requirements:
  - VOIC-02
must_haves:
  truths:
    - "Coturn runs as a docker-compose service for local development"
    - "turnserver.conf uses use-auth-secret mode matching the HMAC credential scheme"
    - "Dockerfile.coturn provides a standalone Coturn image for Coolify production deployment"
    - "Relay port range is configured and mapped for peer connections"
  artifacts:
    - path: "docker-compose.yml"
      provides: "coturn service definition"
      contains: "coturn/coturn"
    - path: "priv/coturn/turnserver.conf"
      provides: "Coturn config with use-auth-secret"
      contains: "use-auth-secret"
    - path: "Dockerfile.coturn"
      provides: "Standalone Coturn image for Coolify"
      contains: "coturn/coturn"
  key_links:
    - from: "docker-compose.yml coturn service"
      to: "priv/coturn/turnserver.conf"
      via: "volume mount into container at /etc/coturn/turnserver.conf"
      pattern: "priv/coturn/turnserver.conf"
    - from: "priv/coturn/turnserver.conf"
      to: "TURN_SECRET env var"
      via: "static-auth-secret read at container startup"
      pattern: "static-auth-secret"
---

<objective>
Ship Coturn as infrastructure for local development (docker-compose) and production (standalone Dockerfile). This is the self-hosted TURN relay server that enables NAT traversal for users on restrictive networks.

Purpose: Self-hosters shouldn't need an external TURN service. Coturn in docker-compose lets developers test TURN locally. Dockerfile.coturn is for Coolify production deployment as a separate service alongside the Phoenix app.

Output: Three infrastructure files. No Elixir code changes. No new Mix dependencies.
</objective>

<execution_context>
@/home/protojazz/.claude/get-shit-done/workflows/execute-plan.md
@/home/protojazz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-voice-reliability/03-RESEARCH.md

<interfaces>
<!-- Existing docker-compose.yml for reference — follow same patterns -->

Current docker-compose.yml (two services: db, adminer):
```yaml
version: "3.1"

services:
  db:
    image: postgres
    restart: always
    environment:
      POSTGRES_PASSWORD: example
    ports:
      - 5469:5432

  adminer:
    image: adminer
    restart: always
    ports:
      - 8080:8080
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Coturn config and add docker-compose service</name>
  <files>priv/coturn/turnserver.conf, docker-compose.yml</files>
  <action>
**Step 1: Create `priv/coturn/turnserver.conf`**

This is mounted read-only into the Coturn container. Uses `use-auth-secret` mode — this is the HMAC time-limited credential mode that matches the Coturn.ex provider implementation. The `static-auth-secret` is set at container startup via the TURN_SECRET env var substitution (handled by shell when `docker compose up` sources .env or the shell environment).

```
# priv/coturn/turnserver.conf
# Coturn TURN server configuration for local development
# Documentation: https://github.com/coturn/coturn/wiki/turnserver

listening-port=3478
realm=cromulent.local

# HMAC time-limited credential scheme (matches lib/cromulent/turn/coturn.ex)
# Set TURN_SECRET env var before running: export TURN_SECRET=your_secret
use-auth-secret
static-auth-secret=${TURN_SECRET}

# Logging
log-file=stdout
verbose

# Disable TLS for local dev (simpler, HTTP is fine on localhost)
no-tls
no-dtls

# Relay port range — keep small for local dev (1 pair per peer connection)
min-port=49152
max-port=49200
```

**Note:** `${TURN_SECRET}` in turnserver.conf is a Coturn native variable substitution feature — Coturn reads this directly from the environment when the container starts. Operators must have TURN_SECRET set in their shell before running `docker compose up coturn`.

**Step 2: Update `docker-compose.yml`** — Add coturn service after adminer:

```yaml
  coturn:
    image: coturn/coturn:4.6
    restart: unless-stopped
    ports:
      - "3478:3478/tcp"
      - "3478:3478/udp"
      - "49152-49200:49152-49200/udp"
    volumes:
      - ./priv/coturn/turnserver.conf:/etc/coturn/turnserver.conf:ro
    environment:
      - TURN_SECRET=${TURN_SECRET}
    # network_mode: host is the simplest for Linux local dev (avoids Docker NAT breaking TURN relay).
    # Mac/Windows: Remove network_mode and use STUN-only (TURN_PROVIDER unset) until further testing.
    network_mode: host
```

Note: With `network_mode: host`, the `ports:` mapping is ignored (host networking bypasses Docker port mapping). Keep the `ports:` section commented or included — it serves as documentation for what ports Coturn uses and is needed if network_mode is removed for Mac/Windows. Actually for clarity, put `ports:` in a comment when using `network_mode: host` to avoid confusion, and document the Mac/Windows note.

Full updated docker-compose.yml:

```yaml
version: "3.1"

services:
  db:
    image: postgres
    restart: always
    environment:
      POSTGRES_PASSWORD: example
    ports:
      - 5469:5432

  adminer:
    image: adminer
    restart: always
    ports:
      - 8080:8080

  coturn:
    image: coturn/coturn:4.6
    restart: unless-stopped
    # Ports used: 3478 (STUN/TURN signaling), 49152-49200 (relay UDP range)
    # With network_mode: host, port mapping is handled by the host OS directly.
    # For Mac/Windows: remove network_mode and uncomment ports: below.
    # ports:
    #   - "3478:3478/tcp"
    #   - "3478:3478/udp"
    #   - "49152-49200:49152-49200/udp"
    environment:
      - TURN_SECRET=${TURN_SECRET}
    volumes:
      - ./priv/coturn/turnserver.conf:/etc/coturn/turnserver.conf:ro
    network_mode: host
```
  </action>
  <verify>
    <automated>cd /home/protojazz/workspace/cromulent && docker compose config --quiet 2>&1 | head -5 || echo "docker compose config check"</automated>
  </verify>
  <done>priv/coturn/turnserver.conf exists with use-auth-secret and static-auth-secret. docker-compose.yml has coturn service. docker compose config validates without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Create Dockerfile.coturn for production deployment</name>
  <files>Dockerfile.coturn</files>
  <action>
Create `Dockerfile.coturn` in the project root. This is used by Coolify (or any Docker-based host) to run Coturn as a separate service alongside the Phoenix app container.

The file should follow the same comment conventions as the existing `Dockerfile`. It wraps the official `coturn/coturn:4.6` image and copies the turnserver.conf into it, so operators don't need to mount volumes in production — the config is baked into the image.

```dockerfile
# Dockerfile.coturn
# Standalone Coturn TURN server for production deployment (Coolify, Docker).
# Deploy alongside the main app container as a separate service.
#
# Build: docker build -f Dockerfile.coturn -t cromulent-coturn .
# Run:   docker run -e TURN_SECRET=your_secret --network host cromulent-coturn
#
# Required env var: TURN_SECRET (generate with: openssl rand -hex 32)
# Ports: 3478/tcp+udp (STUN/TURN), 49152-65535/udp (relay range)
# Note: --network host is recommended on Linux to avoid Docker NAT issues with TURN relay.

FROM coturn/coturn:4.6

# Copy config (TURN_SECRET is substituted from environment at runtime by Coturn)
COPY priv/coturn/turnserver.conf /etc/coturn/turnserver.conf

EXPOSE 3478/tcp
EXPOSE 3478/udp
# Relay port range — widen for production (was 49152-49200 for local dev)
# Set min-port / max-port in turnserver.conf to match your firewall rules.
EXPOSE 49152-65535/udp
```

Note on production port range: The `priv/coturn/turnserver.conf` has `min-port=49152; max-port=49200` (narrow range for local dev). In production, operators should override with wider range or create a separate production turnserver.conf. Document this in the Dockerfile comment as above.
  </action>
  <verify>
    <automated>test -f /home/protojazz/workspace/cromulent/Dockerfile.coturn && echo "Dockerfile.coturn exists" || echo "MISSING"</automated>
  </verify>
  <done>Dockerfile.coturn exists in project root. Contains FROM coturn/coturn:4.6, COPY for turnserver.conf, and documentation comments for production deployment.</done>
</task>

</tasks>

<verification>
After both tasks:
- `docker compose config` validates successfully (no YAML errors)
- `priv/coturn/turnserver.conf` exists with `use-auth-secret` and `static-auth-secret=${TURN_SECRET}`
- `docker-compose.yml` contains coturn service using `coturn/coturn:4.6`
- `Dockerfile.coturn` exists in project root
</verification>

<success_criteria>
Coturn deployment infrastructure is in place. A developer can run `export TURN_SECRET=test123 && docker compose up coturn` to start a local TURN server. Production deployment is documented via Dockerfile.coturn.
</success_criteria>

<output>
After completion, create `.planning/phases/03-voice-reliability/03-02-SUMMARY.md` with:
- Files created/modified
- Any deviations from the plan
- Operator notes (what env vars to set, how to test)
</output>
