---
phase: 02-notification-system
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/cromulent_web/components/user_popover.ex
  - lib/cromulent_web/components/message_component.ex
  - lib/cromulent_web/components/members_sidebar.ex
autonomous: true
requirements: [NOTF-07]

must_haves:
  truths:
    - "Hovering over a username in a message shows a popover with avatar, display name, online status, and role"
    - "Hovering over a username in the sidebar members list shows the same popover"
    - "Popover appears after ~300ms delay, not instantly"
    - "Popover is info only — no action buttons"
    - "Online/offline status shown as colored dot (green=online)"
    - "Role shown as colored badge (Admin, Moderator, Member)"
  artifacts:
    - path: "lib/cromulent_web/components/user_popover.ex"
      provides: "User popover function component with Flowbite data-popover attributes"
      min_lines: 40
  key_links:
    - from: "lib/cromulent_web/components/message_component.ex"
      to: "lib/cromulent_web/components/user_popover.ex"
      via: "import and render user_popover_wrapper around username"
      pattern: "user_popover_wrapper|data-popover"
    - from: "lib/cromulent_web/components/members_sidebar.ex"
      to: "lib/cromulent_web/components/user_popover.ex"
      via: "import and render user_popover_wrapper around username"
      pattern: "user_popover_wrapper|data-popover"
---

<objective>
Add user popover tooltips that appear on hover over any username display.

Purpose: When users see a username in chat messages or the member sidebar, they can hover to see that person's avatar, display name, online/offline status, and role badge. This completes the "who is this person" experience.

Output: Reusable user popover component using Flowbite's data-popover system, integrated into message author display and sidebar member list.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-notification-system/02-CONTEXT.md
@.planning/phases/02-notification-system/02-RESEARCH.md

<interfaces>
<!-- Key types and contracts the executor needs. -->

From lib/cromulent/accounts/user.ex:
```elixir
schema "users" do
  field :username, :string
  field :role, Ecto.Enum, values: [:admin, :member], default: :member
  # No avatar field — use first-letter avatar circle
end
```

From lib/cromulent_web/components/message_component.ex:
```elixir
# Renders individual messages. The username display is where popover should attach.
# Need to examine current structure to wrap username in popover trigger.
```

From lib/cromulent_web/components/members_sidebar.ex:
```elixir
# Renders member list in right sidebar. Each member name should trigger popover.
# Receives server_presences, all_members, voice_presences as assigns.
```

From assets/js/app.js:
```javascript
import "flowbite/dist/flowbite.phoenix.js";
// Flowbite is already loaded — data-popover-* attributes work automatically
// Flowbite handles popover positioning, show/hide, and delay
```

Note: Flowbite's popover system uses `data-popover-target`, `data-popover-trigger="hover"`,
and `data-popover-placement`. The `delay` attribute may need to be configured for the 300ms
hover delay per user decision. Check Flowbite docs — if delay not supported natively,
use CSS transition-delay or a small JS hook.
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create user popover component</name>
  <files>
    lib/cromulent_web/components/user_popover.ex
  </files>
  <action>
Create `lib/cromulent_web/components/user_popover.ex` as a function component module.

This component provides two things:
1. A **trigger wrapper** that wraps any username text with `data-popover-target` attributes
2. A **popover panel** with the user info card that Flowbite shows on hover

```elixir
defmodule CromulentWeb.Components.UserPopover do
  use Phoenix.Component

  @doc """
  Wraps content (username) with a popover trigger and renders the hidden popover panel.

  ## Attrs
  - user: The user map/struct (must have :id, :username, :role)
  - online: Boolean indicating online status
  - class: Optional additional CSS classes for the trigger span
  """
  attr :user, :map, required: true
  attr :online, :boolean, default: false
  attr :class, :string, default: ""
  slot :inner_block, required: true

  def user_popover_wrapper(assigns) do
    ~H"""
    <span
      data-popover-target={"user-popover-#{@user.id}"}
      data-popover-trigger="hover"
      data-popover-placement="top"
      class={["inline cursor-default", @class]}
    >
      {render_slot(@inner_block)}
    </span>

    <div
      data-popover
      id={"user-popover-#{@user.id}"}
      role="tooltip"
      class="absolute z-50 invisible inline-block w-64 text-sm transition-opacity duration-300 bg-gray-800 border border-gray-700 rounded-lg shadow-lg opacity-0"
    >
      <div class="p-3">
        <div class="flex items-center gap-3">
          <%!-- Avatar circle --%>
          <div class="relative flex-shrink-0">
            <div class="w-10 h-10 rounded-full bg-indigo-600 flex items-center justify-center text-white text-lg font-medium">
              {String.first(@user.username) |> String.upcase()}
            </div>
            <span class={[
              "absolute bottom-0 right-0 w-3 h-3 border-2 border-gray-800 rounded-full",
              if(@online, do: "bg-green-500", else: "bg-gray-500")
            ]}></span>
          </div>

          <%!-- User info --%>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-semibold text-white truncate">{@user.username}</p>
            <div class="flex items-center gap-1.5 mt-1">
              <span class={[
                "inline-flex items-center px-2 py-0.5 rounded text-xs font-medium",
                role_classes(@user.role)
              ]}>
                {role_label(@user.role)}
              </span>
              <span class={["text-xs", if(@online, do: "text-green-400", else: "text-gray-400")]}>
                {if @online, do: "Online", else: "Offline"}
              </span>
            </div>
          </div>
        </div>
      </div>
      <div data-popper-arrow></div>
    </div>
    """
  end

  defp role_classes(:admin), do: "bg-red-600/20 text-red-400"
  defp role_classes(:moderator), do: "bg-purple-600/20 text-purple-400"
  defp role_classes(_), do: "bg-gray-600/20 text-gray-400"

  defp role_label(:admin), do: "Admin"
  defp role_label(:moderator), do: "Moderator"
  defp role_label(_), do: "Member"
end
```

**Regarding the 300ms hover delay:**

Flowbite's popover component supports a `data-popover-delay` attribute (or similar). Check if it works. If Flowbite doesn't support delay natively, the CSS `transition-delay: 300ms` on the opacity transition should provide the visual delay effect. The component already has `duration-300` on the transition which provides a 300ms fade-in. If a true hover delay is needed (no appearance at all for 300ms), add a Flowbite configuration option or use a tiny JS hook — but try the CSS approach first as it's simpler and per Claude's discretion on exact timing.

**Important:** The component uses `data-popover` and `data-popover-target` attributes which Flowbite's Phoenix JS automatically initializes. Since `flowbite.phoenix.js` is already imported in `app.js`, these will work without additional JS hooks. Flowbite re-initializes on LiveView DOM updates.
  </action>
  <verify>
    <automated>cd /home/protojazz/workspace/cromulent && mix compile --no-optional-deps 2>&1 | tail -5</automated>
  </verify>
  <done>
    - UserPopover component created with user_popover_wrapper/1 function component
    - Renders trigger span with data-popover-target pointing to popover panel
    - Popover panel shows: avatar initial circle, username, online/offline status dot, role badge
    - Role badges styled distinctly (Admin=red, Moderator=purple, Member=gray)
    - Online status shown as green dot + "Online" text, offline as gray dot + "Offline" text
    - Uses Flowbite data-popover system — no custom JavaScript needed
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire user popover into message component and members sidebar</name>
  <files>
    lib/cromulent_web/components/message_component.ex
    lib/cromulent_web/components/members_sidebar.ex
  </files>
  <action>
**First, read both files** to understand their current structure and where usernames are rendered.

**message_component.ex:**

1. Add `import CromulentWeb.Components.UserPopover` at the top of the module
2. Find where the message author's username is displayed (likely a `<span>` or `<p>` with the username text)
3. Wrap the username text with the `<.user_popover_wrapper>` component:

```heex
<.user_popover_wrapper user={msg.user} online={false}>
  {msg.user.username}
</.user_popover_wrapper>
```

**Note on online status in messages:** Message components don't typically have access to presence data. For message author popovers, pass `online={false}` as default. The popover still shows the user info correctly — online status is just one field. If presence data is available in the assigns chain, use it. If not, `false` is an acceptable default for message-context popovers. The members sidebar DOES have presence data and will show accurate online/offline status.

**members_sidebar.ex:**

1. Add `import CromulentWeb.Components.UserPopover` at the top
2. Find where member usernames are rendered in the sidebar list
3. Wrap each username with `<.user_popover_wrapper>`:

```heex
<.user_popover_wrapper user={member} online={is_online?(member, server_presences)}>
  {member.username}
</.user_popover_wrapper>
```

The members sidebar already has access to `server_presences` which tracks online users. Use it to determine the `online` boolean for each member.

**Placement consideration:** The sidebar is on the right edge of the screen. Set `data-popover-placement="left"` for sidebar popovers to prevent the popover from being cut off by the viewport edge. You can do this by either:
- Adding a `placement` attr to the component and defaulting to "top"
- Or using a separate component call with `data-popover-placement="left"` override

If adding a placement attr is cleaner, update the UserPopover component to accept an optional `placement` attr (default "top").

**IMPORTANT:** Ensure unique popover IDs. The popover ID is `user-popover-#{user.id}`. If the same user appears in both the sidebar AND a message, there will be duplicate IDs. To fix this, add a `context` attr to the component:

```elixir
attr :context, :string, default: "default"
# Then use: id={"user-popover-#{@context}-#{@user.id}"}
# And: data-popover-target={"user-popover-#{@context}-#{@user.id}"}
```

Use `context="message"` in message_component and `context="sidebar"` in members_sidebar.
  </action>
  <verify>
    <automated>cd /home/protojazz/workspace/cromulent && mix compile --no-optional-deps 2>&1 | tail -5</automated>
  </verify>
  <done>
    - Message author usernames wrapped with user_popover_wrapper (popover appears on hover)
    - Sidebar member usernames wrapped with user_popover_wrapper (popover appears on hover)
    - Sidebar popovers use left placement to avoid viewport clipping
    - Online/offline status accurate in sidebar (uses presence data)
    - No duplicate popover IDs (context prefix differentiates message vs sidebar)
    - Popover info-only — no action buttons, just avatar, name, status, role
  </done>
</task>

</tasks>

<verification>
1. `mix compile` succeeds without new warnings
2. Hover over a username in a chat message — popover appears with user info
3. Hover over a username in the right sidebar — popover appears with user info
4. Popover shows: avatar initial, display name, online/offline dot, role badge
5. Sidebar popover positions to the left (not cut off by viewport edge)
6. Popover disappears when mouse moves away
7. No duplicate ID warnings in browser console
</verification>

<success_criteria>
- User popover appears on hover over any username with ~300ms delay
- Popover shows avatar, display name, online/offline status, and role badge
- Works in both message context and sidebar context
- Info-only — no buttons or actions in popover
- Flowbite handles positioning automatically
</success_criteria>

<output>
After completion, create `.planning/phases/02-notification-system/02-03-SUMMARY.md`
</output>
