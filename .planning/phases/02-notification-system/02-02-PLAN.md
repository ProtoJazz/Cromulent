---
phase: 02-notification-system
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - lib/cromulent/notifications.ex
  - lib/cromulent_web/components/notification_inbox.ex
  - lib/cromulent_web/components/layouts/app.html.heex
  - lib/cromulent_web/live/channel_live.ex
autonomous: true
requirements: [NOTF-06]

must_haves:
  truths:
    - "Bell icon visible in the top header bar with unread notification count badge"
    - "Clicking bell icon opens dropdown showing list of unread notifications"
    - "Each notification shows author, channel name, message snippet, and timestamp"
    - "Clicking a notification navigates to that channel"
    - "Mark all as read button clears all notifications from inbox"
    - "Bell badge count updates in real-time when new mentions arrive"
  artifacts:
    - path: "lib/cromulent_web/components/notification_inbox.ex"
      provides: "Notification inbox LiveComponent with dropdown UI"
      min_lines: 80
    - path: "lib/cromulent/notifications.ex"
      provides: "list_unread_notifications/2 and mark_all_read/1 query functions"
      contains: "list_unread_notifications"
  key_links:
    - from: "lib/cromulent_web/components/layouts/app.html.heex"
      to: "lib/cromulent_web/components/notification_inbox.ex"
      via: "live_component render in header bar"
      pattern: "NotificationInbox"
    - from: "lib/cromulent_web/components/notification_inbox.ex"
      to: "lib/cromulent/notifications.ex"
      via: "list_unread_notifications query"
      pattern: "list_unread_notifications"
    - from: "lib/cromulent_web/live/channel_live.ex"
      to: "lib/cromulent_web/components/notification_inbox.ex"
      via: "send_update on :mention_changed to refresh inbox"
      pattern: "send_update.*NotificationInbox"
---

<objective>
Add a notification inbox with bell icon in the header bar.

Purpose: Users need a central place to see missed mentions and navigate to them. The bell icon with unread count provides at-a-glance awareness, and the dropdown panel gives quick access to all pending notifications.

Output: Bell icon in the desktop toolbar header bar, dropdown panel with notification list, "mark all as read" action, real-time badge count updates via PubSub.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-notification-system/02-CONTEXT.md
@.planning/phases/02-notification-system/02-RESEARCH.md
@.planning/phases/02-notification-system/02-01-SUMMARY.md

<interfaces>
<!-- Key types and contracts the executor needs. -->

From lib/cromulent/notifications/notification.ex:
```elixir
schema "notifications" do
  field :mention_type, Ecto.Enum, values: [:user, :group, :here, :everyone]
  field :read_at, :utc_datetime
  belongs_to :user, Cromulent.Accounts.User
  belongs_to :channel, Cromulent.Channels.Channel
  belongs_to :message, Cromulent.Messages.Message
  timestamps(type: :utc_datetime)
end
```

From lib/cromulent/notifications.ex:
```elixir
# Existing functions:
def mark_channel_read(user_id, channel_id, message_id)
def unread_counts_for_user(user_id)
def mention_counts_for_user(user_id)
def fan_out_notifications(message, mention_attrs_list, channel_member_ids, online_user_ids)
# We need to ADD: list_unread_notifications/2 and mark_all_read/1
```

From lib/cromulent_web/components/layouts/app.html.heex:
```heex
<!-- Desktop toolbar (line 68-103): -->
<div class="hidden lg:flex items-center justify-between px-3 h-12 bg-gray-900 border-b border-gray-700">
  <!-- Left: channels toggle button -->
  <!-- Right: members toggle button -->
  <!-- Bell icon goes BETWEEN these two buttons -->
</div>
```

From lib/cromulent_web/live/channel_live.ex (after Plan 01):
```elixir
# mount/3 already subscribes to user:#{user_id} PubSub topic
# handle_info({:mention_changed}, socket) already exists â€” triggers refresh_unread_counts
# We need to also trigger inbox component refresh here
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add inbox query functions to Notifications context</name>
  <files>
    lib/cromulent/notifications.ex
  </files>
  <action>
Add two new public functions to `Cromulent.Notifications`:

**list_unread_notifications/2:**

```elixir
def list_unread_notifications(user_id, limit \\ 20) do
  from(n in Notification,
    where: n.user_id == ^user_id and is_nil(n.read_at),
    join: m in assoc(n, :message),
    join: u in assoc(m, :user),
    join: c in assoc(n, :channel),
    order_by: [desc: n.inserted_at],
    limit: ^limit,
    select: %{
      id: n.id,
      channel_id: c.id,
      channel_name: c.name,
      channel_slug: c.slug,
      author: u.username,
      message_preview: fragment("LEFT(?, 100)", m.body),
      inserted_at: n.inserted_at,
      mention_type: n.mention_type
    }
  )
  |> Repo.all()
end
```

Check whether the `channels` table has a `slug` column. If not, use `c.name` for both `channel_name` and construct the slug. The `channel_slug` is needed for navigation via `push_patch`.

**mark_all_read/1:**

```elixir
def mark_all_read(user_id) do
  now = DateTime.utc_now() |> DateTime.truncate(:second)

  from(n in Notification,
    where: n.user_id == ^user_id and is_nil(n.read_at)
  )
  |> Repo.update_all(set: [read_at: now])
end
```

Also add an `unread_notification_count/1` function for the badge:

```elixir
def unread_notification_count(user_id) do
  from(n in Notification,
    where: n.user_id == ^user_id and is_nil(n.read_at),
    select: count(n.id)
  )
  |> Repo.one()
end
```
  </action>
  <verify>
    <automated>cd /home/protojazz/workspace/cromulent && mix compile --no-optional-deps 2>&1 | tail -5</automated>
  </verify>
  <done>
    - list_unread_notifications/2 returns up to 20 unread notifications with author, channel, message preview, and timestamp
    - mark_all_read/1 sets read_at on all unread notifications for a user
    - unread_notification_count/1 returns integer count for badge display
    - All functions compile without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create notification inbox LiveComponent and wire into header bar</name>
  <files>
    lib/cromulent_web/components/notification_inbox.ex
    lib/cromulent_web/components/layouts/app.html.heex
    lib/cromulent_web/live/channel_live.ex
  </files>
  <action>
**Create lib/cromulent_web/components/notification_inbox.ex as a LiveComponent:**

Use `Phoenix.LiveComponent` (not a function component) so it can manage its own state and handle events independently.

```elixir
defmodule CromulentWeb.Components.NotificationInbox do
  use CromulentWeb, :live_component

  def render(assigns) do
    ~H"""
    <div class="relative">
      <button
        phx-click="toggle_inbox"
        phx-target={@myself}
        class="relative p-1.5 text-gray-400 hover:text-white hover:bg-gray-700 rounded"
        title="Notifications"
      >
        <!-- Bell SVG icon (Heroicons bell) -->
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
        </svg>
        <!-- Badge count -->
        <span :if={@unread_count > 0}
          class="absolute -top-1 -right-1 inline-flex items-center justify-center w-4 h-4 text-[10px] font-bold leading-none text-white bg-red-600 rounded-full">
          {if @unread_count > 99, do: "99+", else: @unread_count}
        </span>
      </button>

      <!-- Dropdown panel -->
      <div :if={@inbox_open}
        class="absolute right-0 mt-2 w-96 bg-gray-800 border border-gray-700 rounded-lg shadow-xl z-50 max-h-96 overflow-y-auto"
        phx-click-away="close_inbox"
        phx-target={@myself}
      >
        <!-- Header -->
        <div class="flex items-center justify-between px-4 py-3 border-b border-gray-700">
          <h3 class="text-sm font-semibold text-white">Notifications</h3>
          <button :if={@unread_count > 0}
            phx-click="mark_all_read"
            phx-target={@myself}
            class="text-xs text-indigo-400 hover:text-indigo-300">
            Mark all read
          </button>
        </div>

        <!-- Empty state -->
        <div :if={@notifications == []} class="px-4 py-8 text-center text-gray-400 text-sm">
          No notifications yet
        </div>

        <!-- Notification list -->
        <div :if={@notifications != []} class="divide-y divide-gray-700">
          <div :for={notif <- @notifications}
            phx-click="navigate_to_notification"
            phx-value-channel-slug={notif.channel_slug}
            phx-target={@myself}
            class="px-4 py-3 hover:bg-gray-700 cursor-pointer">
            <div class="flex items-start gap-3">
              <div class="flex-shrink-0 w-8 h-8 rounded-full bg-indigo-600 flex items-center justify-center text-white text-xs font-medium">
                {String.first(notif.author) |> String.upcase()}
              </div>
              <div class="flex-1 min-w-0">
                <p class="text-sm text-white font-medium">
                  <span>{notif.author}</span>
                  <span class="text-gray-400 font-normal"> in </span>
                  <span class="text-indigo-400">#{notif.channel_name}</span>
                </p>
                <p class="text-xs text-gray-400 mt-1 line-clamp-2">
                  {notif.message_preview}
                </p>
                <p class="text-xs text-gray-500 mt-1">
                  {format_time(notif.inserted_at)}
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    """
  end

  def update(assigns, socket) do
    socket = assign(socket, assigns)

    if connected?(socket) do
      notifications = Cromulent.Notifications.list_unread_notifications(assigns.current_user.id)
      {:ok,
       socket
       |> assign(:notifications, notifications)
       |> assign(:unread_count, length(notifications))
       |> assign_new(:inbox_open, fn -> false end)}
    else
      {:ok,
       socket
       |> assign(:notifications, [])
       |> assign(:unread_count, 0)
       |> assign_new(:inbox_open, fn -> false end)}
    end
  end

  def handle_event("toggle_inbox", _params, socket) do
    {:noreply, assign(socket, :inbox_open, !socket.assigns.inbox_open)}
  end

  def handle_event("close_inbox", _params, socket) do
    {:noreply, assign(socket, :inbox_open, false)}
  end

  def handle_event("mark_all_read", _params, socket) do
    Cromulent.Notifications.mark_all_read(socket.assigns.current_user.id)
    {:noreply,
     socket
     |> assign(:notifications, [])
     |> assign(:unread_count, 0)}
  end

  def handle_event("navigate_to_notification", %{"channel-slug" => slug}, socket) do
    send(self(), {:navigate_to_channel, slug})
    {:noreply, assign(socket, :inbox_open, false)}
  end

  defp format_time(datetime) do
    Calendar.strftime(datetime, "%I:%M %p")
  end
end
```

Key design decisions per user context:
- Bell icon in top header bar (NOT sidebar)
- Dropdown panel on click with rich preview items
- "Mark all as read" button (no per-item dismiss)
- Click item navigates to channel
- `phx-click-away` closes dropdown when clicking outside

**Wire into app.html.heex:**

In the desktop toolbar div (the `hidden lg:flex` div between the channels toggle button and the members toggle button), add the bell icon. Place it in a flex container to the left of the members toggle:

Replace the desktop toolbar section to include a middle area with the bell icon:

```heex
<div class="hidden lg:flex items-center justify-between px-3 h-12 bg-gray-900 border-b border-gray-700">
  <!-- Left: channels toggle (existing) -->
  <button ...>channels toggle</button>

  <!-- Right group: bell + members toggle -->
  <div class="flex items-center gap-1">
    <%= if assigns[:current_user] do %>
      <.live_component
        module={CromulentWeb.Components.NotificationInbox}
        id="notification-inbox"
        current_user={@current_user}
      />
    <% end %>
    <button ...>members toggle</button>
  </div>
</div>
```

Also add the bell icon to the mobile top bar (between the title and the members button).

**Wire refresh in channel_live.ex:**

In the existing `handle_info({:mention_changed}, socket)` clause, add a `send_update` call to refresh the inbox component:

```elixir
def handle_info({:mention_changed}, socket) do
  send_update(CromulentWeb.Components.NotificationInbox,
    id: "notification-inbox",
    current_user: socket.assigns.current_user
  )
  {:noreply, refresh_unread_counts(socket)}
end
```

Also handle the `{:navigate_to_channel, slug}` message sent by the inbox component:

```elixir
def handle_info({:navigate_to_channel, slug}, socket) do
  {:noreply, push_patch(socket, to: ~p"/channels/#{slug}")}
end
```
  </action>
  <verify>
    <automated>cd /home/protojazz/workspace/cromulent && mix compile --no-optional-deps 2>&1 | tail -5</automated>
  </verify>
  <done>
    - Bell icon visible in desktop toolbar header bar with red badge showing unread count
    - Bell icon also in mobile top bar
    - Clicking bell opens dropdown panel with notification list
    - Each notification shows author avatar initial, author name, channel name, message snippet, timestamp
    - Clicking notification navigates to the mentioned channel and closes dropdown
    - "Mark all as read" button clears all notifications
    - Badge count updates in real-time when new mentions arrive via :mention_changed PubSub
    - Dropdown closes when clicking outside (phx-click-away)
  </done>
</task>

</tasks>

<verification>
1. `mix compile` succeeds without new warnings
2. Bell icon visible in top header bar when logged in
3. Badge shows correct count of unread notifications
4. Clicking bell opens dropdown panel
5. Notification items show author, channel, message preview, time
6. Clicking a notification navigates to the correct channel
7. "Mark all as read" clears the badge and empties the list
8. New mentions update the badge count in real-time
</verification>

<success_criteria>
- Notification inbox dropdown renders in header bar with bell icon and badge
- Unread notifications queryable with author, channel, message preview, and timestamp
- Navigation from inbox item to channel works correctly
- Mark all read clears all unread notifications
- Real-time badge updates via PubSub
</success_criteria>

<output>
After completion, create `.planning/phases/02-notification-system/02-02-SUMMARY.md`
</output>
